# Schema Generator 配置指南

本指南介绍如何使用 Schema Generator 的高级功能：嵌套对象、字段规范化和站点级默认配置。

---

## 一、快速开始

### 基础用法

```python
from backend.services.schema_generator import SchemaGenerator

# 创建生成器实例
generator = SchemaGenerator()

# 生成 Article schema
schema = generator.generate(
    "Article",
    "Breaking News: Major Announcement",
    author="John Doe"
)
```

### 使用站点默认配置

```python
# 创建带站点默认值的生成器
generator = SchemaGenerator(site_defaults={
    "publisher_name": "My News Site",
    "publisher_logo": "https://example.com/logo.png",
    "brand_name": "My Brand",
    "inLanguage": "en-US"
})

# 生成时自动应用默认值
schema = generator.generate("Article", "News Article")
# schema["publisher"]["name"] == "My News Site"

# 可通过 kwargs 覆盖默认值
schema = generator.generate(
    "Article", 
    "Special Article",
    publisher_name="Special Publisher"
)
# schema["publisher"]["name"] == "Special Publisher"
```

---

## 二、嵌套对象详解

### Article 类型

#### Publisher (Organization)

```python
schema = generator.generate(
    "Article",
    "Article Title",
    publisher_name="Tech News Daily",
    publisher_logo="https://example.com/logo.png"
)

# 输出:
{
    "publisher": {
        "@type": "Organization",
        "name": "Tech News Daily",
        "logo": {
            "@type": "ImageObject",
            "url": "https://example.com/logo.png"
        }
    }
}
```

#### Image (ImageObject 数组)

```python
schema = generator.generate(
    "Article",
    "Article Title",
    image=["https://example.com/img1.jpg", "https://example.com/img2.jpg"]
)

# 输出:
{
    "image": [
        {"@type": "ImageObject", "url": "https://example.com/img1.jpg"},
        {"@type": "ImageObject", "url": "https://example.com/img2.jpg"}
    ]
}
```

#### Author (Person)

```python
# 简单字符串
schema = generator.generate("Article", "Title", author="Jane Smith")
# author: {"@type": "Person", "name": "Jane Smith"}

# 完整对象
schema = generator.generate("Article", "Title", author={
    "name": "Jane Smith",
    "url": "https://example.com/author/jane",
    "email": "jane@example.com"
})
# author: {"@type": "Person", "name": "Jane Smith", "url": "...", "email": "..."}
```

### Product 类型

#### Offers (Offer)

```python
schema = generator.generate(
    "Product",
    "Product Name\nDescription",
    offers={
        "price": "99.99",
        "priceCurrency": "USD",  # 自动规范化为大写
        "availability": "https://schema.org/InStock",
        "url": "https://example.com/buy"
    }
)

# 输出:
{
    "offers": {
        "@type": "Offer",
        "price": "99.99",
        "priceCurrency": "USD",
        "availability": "https://schema.org/InStock",
        "url": "https://example.com/buy"
    }
}
```

#### AggregateRating

```python
schema = generator.generate(
    "Product",
    "Product Name\nDescription",
    aggregateRating={
        "ratingValue": 4.5,
        "reviewCount": 120
    }
)

# 输出:
{
    "aggregateRating": {
        "@type": "AggregateRating",
        "ratingValue": 4.5,
        "reviewCount": 120,
        "bestRating": 5,      # 自动添加
        "worstRating": 1      # 自动添加
    }
}
```

#### Brand

```python
# 使用站点默认
generator = SchemaGenerator(site_defaults={"brand_name": "My Brand"})
schema = generator.generate("Product", "Product\nDesc")
# brand: {"@type": "Brand", "name": "My Brand"}

# 或直接指定
schema = generator.generate("Product", "Product\nDesc", brand_name="Premium Brand")
# brand: {"@type": "Brand", "name": "Premium Brand"}
```

### Recipe 类型

#### RecipeInstructions (HowToStep 数组)

```python
# 从字符串自动拆分
schema = generator.generate(
    "Recipe",
    "Delicious Cake",
    recipeIngredient=["flour", "sugar", "eggs"],
    recipeInstructions="Mix ingredients\nBake at 350F for 30 min\nLet cool"
)

# 输出:
{
    "recipeInstructions": [
        {
            "@type": "HowToStep",
            "text": "Mix ingredients",
            "name": "Step 1",
            "position": 1
        },
        {
            "@type": "HowToStep",
            "text": "Bake at 350F for 30 min",
            "name": "Step 2",
            "position": 2
        },
        {
            "@type": "HowToStep",
            "text": "Let cool",
            "name": "Step 3",
            "position": 3
        }
    ]
}
```

#### Nutrition (NutritionInformation)

```python
schema = generator.generate(
    "Recipe",
    "Healthy Salad",
    recipeIngredient=["lettuce", "tomato"],
    recipeInstructions="Mix vegetables",
    nutrition={
        "calories": "150 calories",
        "fatContent": "5g",
        "proteinContent": "8g",
        "carbohydrateContent": "20g"
    }
)

# 输出:
{
    "nutrition": {
        "@type": "NutritionInformation",
        "calories": "150 calories",
        "fatContent": "5g",
        "proteinContent": "8g",
        "carbohydrateContent": "20g"
    }
}
```

### Event 类型

#### Location (Place + PostalAddress)

```python
schema = generator.generate(
    "Event",
    "Tech Conference 2025",
    startDate="2025-12-01",
    location={
        "name": "Convention Center",
        "address": {
            "streetAddress": "123 Main St",
            "addressLocality": "San Francisco",
            "addressRegion": "CA",
            "postalCode": "94102",
            "addressCountry": "US"
        }
    }
)

# 输出:
{
    "location": {
        "@type": "Place",
        "name": "Convention Center",
        "address": {
            "@type": "PostalAddress",
            "streetAddress": "123 Main St",
            "addressLocality": "San Francisco",
            "addressRegion": "CA",
            "postalCode": "94102",
            "addressCountry": "US"
        }
    }
}
```

#### Organizer (Organization/Person)

```python
# 简单字符串（默认为 Organization）
schema = generator.generate(
    "Event",
    "Community Meetup",
    startDate="2025-11-15",
    location={"name": "Community Hall"},
    organizer="Tech Community"
)
# organizer: {"@type": "Organization", "name": "Tech Community"}

# 完整对象
schema = generator.generate(
    "Event",
    "Workshop",
    startDate="2025-11-20",
    location={"name": "Workshop Space"},
    organizer={
        "@type": "Person",
        "name": "Jane Doe",
        "email": "jane@example.com"
    }
)
# organizer: {"@type": "Person", "name": "Jane Doe", "email": "..."}
```

---

## 三、字段规范化

### 日期规范化 (ISO8601)

```python
from datetime import datetime

# 支持 datetime 对象
schema = generator.generate(
    "Article",
    "News",
    datePublished=datetime(2025, 10, 21, 14, 30)
)
# datePublished: "2025-10-21T14:30:00"

# 支持多种字符串格式
schema = generator.generate("Article", "News", datePublished="2025/10/21")
# datePublished: "2025-10-21"

schema = generator.generate("Article", "News", datePublished="21-10-2025")
# datePublished: "2025-10-21"
```

### URL 规范化

```python
# 绝对 URL 保持不变
schema = generator.generate("Article", "News", url="https://example.com/article")
# url: "https://example.com/article"

# 相对 URL + base_url（内部使用）
# 在生成器内部，image/logo 等字段会自动使用 url 参数作为 base_url
```

### 货币代码规范化 (ISO4217)

```python
# 自动转大写
schema = generator.generate(
    "Product",
    "Product\nDesc",
    offers={"price": "99.99", "priceCurrency": "eur"}
)
# priceCurrency: "EUR"

# 无效代码默认为 USD
schema = generator.generate(
    "Product",
    "Product\nDesc",
    offers={"price": "99.99", "priceCurrency": "INVALID"}
)
# priceCurrency: "USD"
```

**支持的货币代码** (20 种):  
USD, EUR, GBP, JPY, CNY, AUD, CAD, CHF, HKD, SGD, SEK, NOK, DKK, NZD, KRW, INR, BRL, RUB, ZAR, MXN

### 语言标签规范化 (BCP47)

```python
# 自动转小写
schema = generator.generate("Article", "News", inLanguage="EN-US")
# inLanguage: "en-us"

# 复杂标签提取主语言
schema = generator.generate("Article", "News", inLanguage="zh-Hans-CN")
# inLanguage: "zh"

# 无效标签默认为 en
schema = generator.generate("Article", "News", inLanguage="INVALID")
# inLanguage: "en"
```

**支持的语言标签** (20 种):  
en, en-US, en-GB, zh, zh-CN, zh-TW, ja, ko, fr, de, es, it, pt, ru, ar, hi, th, vi, id, ms

---

## 四、站点默认配置最佳实践

### WordPress 集成示例

```python
# 在 WordPress 插件中初始化生成器
def get_schema_generator():
    site_defaults = {
        "publisher_name": get_bloginfo('name'),
        "publisher_logo": get_site_icon_url(),
        "inLanguage": get_bloginfo('language'),
        "sameAs": [
            get_option('twitter_url'),
            get_option('facebook_url')
        ]
    }
    return SchemaGenerator(site_defaults=site_defaults)

# 使用时自动应用站点配置
generator = get_schema_generator()
schema = generator.generate("Article", get_the_content())
```

### 多站点配置

```python
# 站点 A 配置
generator_a = SchemaGenerator(site_defaults={
    "publisher_name": "Site A News",
    "publisher_logo": "https://sitea.com/logo.png",
    "brand_name": "Brand A"
})

# 站点 B 配置
generator_b = SchemaGenerator(site_defaults={
    "publisher_name": "Site B Blog",
    "publisher_logo": "https://siteb.com/logo.png",
    "brand_name": "Brand B"
})
```

---

## 五、完整示例

### 新闻文章（Article）

```python
generator = SchemaGenerator(site_defaults={
    "publisher_name": "Tech News Daily",
    "publisher_logo": "https://technews.com/logo.png"
})

schema = generator.generate(
    "Article",
    "AI Breakthrough in 2025\n\nResearchers announce major advancement...",
    url="https://technews.com/ai-breakthrough-2025",
    author="Dr. Jane Smith",
    image=["https://technews.com/images/ai1.jpg", "https://technews.com/images/ai2.jpg"],
    datePublished=datetime(2025, 10, 21),
    wordCount=1500
)
```

### 电商产品（Product）

```python
schema = generator.generate(
    "Product",
    "Premium Laptop\nHigh-performance computing for professionals",
    url="https://shop.com/laptop-pro",
    brand_name="TechBrand",
    image=["https://shop.com/laptop-front.jpg", "https://shop.com/laptop-side.jpg"],
    sku="LAPTOP-PRO-2025",
    gtin13="1234567890123",
    offers={
        "price": "1299.99",
        "priceCurrency": "USD",
        "availability": "https://schema.org/InStock",
        "url": "https://shop.com/buy/laptop-pro"
    },
    aggregateRating={
        "ratingValue": 4.8,
        "reviewCount": 256
    },
    manufacturer="TechCorp Inc"
)
```

### 食谱（Recipe）

```python
schema = generator.generate(
    "Recipe",
    "Chocolate Chip Cookies",
    url="https://recipes.com/chocolate-chip-cookies",
    author="Chef Maria",
    image=["https://recipes.com/cookies.jpg"],
    recipeIngredient=[
        "2 cups all-purpose flour",
        "1 cup butter",
        "1 cup sugar",
        "2 eggs",
        "2 cups chocolate chips"
    ],
    recipeInstructions="Preheat oven to 350F\nMix butter and sugar\nAdd eggs and flour\nFold in chocolate chips\nBake for 12 minutes",
    prepTime="PT15M",
    cookTime="PT12M",
    recipeYield="24 cookies",
    nutrition={
        "calories": "150 calories",
        "fatContent": "8g",
        "proteinContent": "2g",
        "carbohydrateContent": "18g"
    }
)
```

---

## 六、常见问题

### Q: 如何禁用站点默认配置？
A: 传递 `None` 或空字典即可：
```python
generator = SchemaGenerator(site_defaults=None)
# 或
generator = SchemaGenerator(site_defaults={})
```

### Q: 如何覆盖站点默认值？
A: 在 `generate()` 调用时传递相同的键：
```python
generator = SchemaGenerator(site_defaults={"publisher_name": "Default"})
schema = generator.generate("Article", "News", publisher_name="Override")
# publisher_name 将使用 "Override"
```

### Q: 支持哪些嵌套对象类型？
A: 当前支持：
- Organization, Person, Brand
- ImageObject, Place, PostalAddress
- Offer, AggregateRating
- HowToStep, NutritionInformation
- ContactPoint

### Q: 如何验证生成的 Schema？
A: 使用 SchemaValidator：
```python
from backend.services.schema_validator import SchemaValidator

validator = SchemaValidator()
result = validator.validate(schema)
print(f"Valid: {result['is_valid']}")
print(f"Score: {result['completeness_score']}")
```

---

**更多信息**: 参见 [API文档.md](./API文档.md) 和 [P0-1-Generator-Completion-Report.md](./P0-1-Generator-Completion-Report.md)

